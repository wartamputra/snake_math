<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Snake - Ular Matematika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: none; /* Mencegah scroll saat main di HP */
            background-color: #1a202c;
            color: white;
            overflow: hidden;
        }
        canvas {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #2d3748;
            border-radius: 8px;
        }
        .game-btn {
            transition: transform 0.1s;
        }
        .game-btn:active {
            transform: scale(0.95);
            background-color: #4a5568;
        }
        /* Grid background effect */
        .grid-bg {
            background-image: radial-gradient(#4a5568 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center bg-gray-900">

    <!-- Header & Skor -->
    <div class="w-full max-w-md px-4 mb-2 flex justify-between items-center">
        <div>
            <h1 class="text-xl text-green-400 font-bold">Math Snake üêç</h1>
            <p class="text-xs text-gray-400">Makan jawaban yang benar!</p>
        </div>
        <div class="text-right">
            <div class="text-2xl font-bold text-yellow-400" id="scoreDisplay">0</div>
            <div class="text-xs text-gray-400">Skor Tertinggi: <span id="highScoreDisplay">0</span></div>
        </div>
    </div>

    <!-- Area Pertanyaan -->
    <div class="w-full max-w-md px-4 mb-4 text-center">
        <div class="bg-indigo-600 rounded-lg py-2 px-4 shadow-lg border-2 border-indigo-400">
            <span class="text-sm text-indigo-200 block uppercase tracking-wider">Soal</span>
            <span id="questionDisplay" class="text-3xl font-bold text-white">Tekan Mulai</span>
        </div>
    </div>

    <!-- Container Game -->
    <div class="relative group">
        <canvas id="gameCanvas" width="400" height="400" class="border-4 border-gray-700 grid-bg max-w-[95vw] max-h-[50vh]"></canvas>
        
        <!-- Overlay Start / Game Over -->
        <div id="overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center rounded-lg z-10">
            <h2 id="overlayTitle" class="text-4xl font-bold text-green-500 mb-2">Math Snake</h2>
            <p id="overlayMessage" class="text-gray-300 mb-6 text-center px-4">Gunakan panah atau tombol untuk mengarahkan ular.</p>
            <button onclick="startGame()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105">
                Mulai Main
            </button>
        </div>
    </div>

    <!-- Kontrol Mobile (D-Pad) -->
    <div class="mt-4 grid grid-cols-3 gap-2 w-48 select-none touch-none">
        <div></div>
        <button class="game-btn bg-gray-700 p-4 rounded-lg text-2xl flex items-center justify-center border-b-4 border-gray-900" onpointerdown="changeDirection('UP')">‚¨ÜÔ∏è</button>
        <div></div>
        <button class="game-btn bg-gray-700 p-4 rounded-lg text-2xl flex items-center justify-center border-b-4 border-gray-900" onpointerdown="changeDirection('LEFT')">‚¨ÖÔ∏è</button>
        <button class="game-btn bg-gray-700 p-4 rounded-lg text-2xl flex items-center justify-center border-b-4 border-gray-900" onpointerdown="changeDirection('DOWN')">‚¨áÔ∏è</button>
        <button class="game-btn bg-gray-700 p-4 rounded-lg text-2xl flex items-center justify-center border-b-4 border-gray-900" onpointerdown="changeDirection('RIGHT')">‚û°Ô∏è</button>
    </div>

    <script>
        // --- Konfigurasi Game ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20; // Ukuran setiap kotak grid
        let tileCount = 20; // Jumlah kotak per baris/kolom (akan disesuaikan saat resize)
        
        // --- State Game ---
        let score = 0;
        let highScore = localStorage.getItem('mathSnakeHighScore') || 0;
        let gameRunning = false;
        let speed = 150; // Kecepatan awal (ms)
        let gameLoop;
        
        // Posisi Ular & Arah
        let snake = [];
        let dx = 0;
        let dy = 0;
        
        // Logika Matematika & Makanan
        let currentQuestion = {};
        let foods = []; // Array object {x, y, value, isCorrect}

        // --- Inisialisasi Tampilan ---
        document.getElementById('highScoreDisplay').innerText = highScore;

        // Fungsi Resize untuk Responsif
        function resizeCanvas() {
            // Kita ingin canvas kotak sempurna, maksimal lebar layar HP
            let size = Math.min(window.innerWidth - 30, 400); 
            // Pastikan kelipatan gridSize
            size = Math.floor(size / gridSize) * gridSize;
            
            canvas.width = size;
            canvas.height = size;
            tileCount = size / gridSize;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Logika Inti Game ---

        function startGame() {
            if (gameRunning) return;
            
            // Reset Variabel
            snake = [{x: 10, y: 10}, {x: 10, y: 11}, {x: 10, y: 12}]; // Kepala di index 0
            dx = 0;
            dy = -1; // Gerak ke atas
            score = 0;
            speed = 150;
            
            updateScoreUI();
            document.getElementById('overlay').classList.add('hidden');
            
            generateQuestionAndFood();
            gameRunning = true;
            gameLoop = setTimeout(runGameCycle, speed);
        }

        function runGameCycle() {
            if (!gameRunning) return;

            advanceSnake();
            checkCollisions();
            draw();

            if (gameRunning) {
                // Sedikit percepatan setiap kelipatan skor 5
                let currentSpeed = Math.max(80, 150 - (Math.floor(score / 5) * 5));
                gameLoop = setTimeout(runGameCycle, currentSpeed);
            }
        }

        function generateQuestionAndFood() {
            // 1. Buat Soal Matematika
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a, b, ans;

            // Buat angka agar hasilnya masuk akal (0-99)
            if (op === '+') {
                a = Math.floor(Math.random() * 20);
                b = Math.floor(Math.random() * 20);
                ans = a + b;
            } else if (op === '-') {
                a = Math.floor(Math.random() * 20) + 10;
                b = Math.floor(Math.random() * 10);
                ans = a - b;
            } else { // Perkalian
                a = Math.floor(Math.random() * 9) + 1;
                b = Math.floor(Math.random() * 9) + 1;
                ans = a * b;
            }

            currentQuestion = { text: `${a} ${op} ${b} = ?`, answer: ans };
            document.getElementById('questionDisplay').innerText = currentQuestion.text;

            // 2. Buat Opsi Jawaban (Makanan)
            foods = [];
            
            // Buat 1 jawaban benar
            let correctFood = spawnFoodItem(ans, true);
            foods.push(correctFood);

            // Buat 2 jawaban salah (pengecoh)
            for (let i = 0; i < 2; i++) {
                let wrongAns;
                do {
                    wrongAns = ans + Math.floor(Math.random() * 10) - 5;
                } while (wrongAns === ans || wrongAns < 0 || foods.some(f => f.value === wrongAns));
                
                foods.push(spawnFoodItem(wrongAns, false));
            }
        }

        function spawnFoodItem(value, isCorrect) {
            let item;
            while (true) {
                item = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount),
                    value: value,
                    isCorrect: isCorrect
                };
                
                // Cek agar tidak muncul di tubuh ular atau menumpuk makanan lain
                let collision = false;
                for (let part of snake) {
                    if (part.x === item.x && part.y === item.y) collision = true;
                }
                for (let f of foods) {
                    if (f.x === item.x && f.y === item.y) collision = true;
                }
                
                if (!collision) break;
            }
            return item;
        }

        function advanceSnake() {
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head); // Tambah kepala baru

            // Cek apakah makan
            let ateIndex = -1;
            for (let i = 0; i < foods.length; i++) {
                if (head.x === foods[i].x && head.y === foods[i].y) {
                    ateIndex = i;
                    break;
                }
            }

            if (ateIndex !== -1) {
                const eatenFood = foods[ateIndex];
                if (eatenFood.isCorrect) {
                    // Benar!
                    score++;
                    updateScoreUI();
                    generateQuestionAndFood();
                    // Jangan pop ekor (ular memanjang)
                } else {
                    // Salah Makan!
                    gameOver("Salah Makan! Jawabannya " + currentQuestion.answer);
                }
            } else {
                // Tidak makan, buang ekor lama
                snake.pop();
            }
        }

        function checkCollisions() {
            const head = snake[0];

            // Tabrak Dinding
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver("Menabrak Dinding!");
                return;
            }

            // Tabrak Diri Sendiri
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver("Menabrak Ekor Sendiri!");
                    return;
                }
            }
        }

        function gameOver(reason) {
            gameRunning = false;
            clearTimeout(gameLoop);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('mathSnakeHighScore', highScore);
                document.getElementById('highScoreDisplay').innerText = highScore;
            }

            document.getElementById('overlayTitle').innerText = "Game Over!";
            document.getElementById('overlayMessage').innerHTML = `<span class="text-red-400 font-bold">${reason}</span><br>Skor Akhir: ${score}`;
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('questionDisplay').innerText = "Selesai";
        }

        function updateScoreUI() {
            document.getElementById('scoreDisplay').innerText = score;
        }

        // --- Rendering (Canvas Drawing) ---
        function draw() {
            // Bersihkan Canvas
            ctx.fillStyle = '#2d3748'; // Warna Background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Gambar Makanan (Angka)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 14px Fredoka';

            for (let f of foods) {
                // Lingkaran Makanan
                ctx.fillStyle = f.isCorrect ? '#f6e05e' : '#f6e05e'; // Samarkan warnanya agar tidak curang, atau bedakan sedikit utk style
                // Biar fair, semua makanan warnanya sama (kuning), pemain harus baca angkanya
                
                ctx.beginPath();
                ctx.arc(f.x * gridSize + gridSize/2, f.y * gridSize + gridSize/2, gridSize/2 - 2, 0, Math.PI * 2);
                ctx.fill();

                // Angka di dalam makanan
                ctx.fillStyle = '#1a202c';
                ctx.fillText(f.value, f.x * gridSize + gridSize/2, f.y * gridSize + gridSize/2 + 1);
            }

            // Gambar Ular
            for (let i = 0; i < snake.length; i++) {
                // Warna Kepala vs Badan
                ctx.fillStyle = (i === 0) ? '#48bb78' : '#38a169'; 
                
                // Efek rounded pada segmen ular
                let x = snake[i].x * gridSize;
                let y = snake[i].y * gridSize;
                
                ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2);
                
                // Mata Ular (Hanya di kepala)
                if (i === 0) {
                    ctx.fillStyle = 'white';
                    // Logika posisi mata sederhana
                    let eyeSize = 3;
                    if (dx === 1) { // Kanan
                         ctx.fillRect(x + 12, y + 4, eyeSize, eyeSize);
                         ctx.fillRect(x + 12, y + 12, eyeSize, eyeSize);
                    } else if (dx === -1) { // Kiri
                         ctx.fillRect(x + 4, y + 4, eyeSize, eyeSize);
                         ctx.fillRect(x + 4, y + 12, eyeSize, eyeSize);
                    } else if (dy === -1) { // Atas
                         ctx.fillRect(x + 4, y + 4, eyeSize, eyeSize);
                         ctx.fillRect(x + 12, y + 4, eyeSize, eyeSize);
                    } else { // Bawah
                         ctx.fillRect(x + 4, y + 12, eyeSize, eyeSize);
                         ctx.fillRect(x + 12, y + 12, eyeSize, eyeSize);
                    }
                }
            }
        }

        // --- Kontrol Input ---

        function changeDirection(newDir) {
            if (!gameRunning) return;
            
            // Cegah balik arah langsung (misal: lagi ke atas, gak bisa langsung ke bawah)
            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingRight = dx === 1;
            const goingLeft = dx === -1;

            if (newDir === 'LEFT' && !goingRight) {
                dx = -1; dy = 0;
            }
            if (newDir === 'UP' && !goingDown) {
                dx = 0; dy = -1;
            }
            if (newDir === 'RIGHT' && !goingLeft) {
                dx = 1; dy = 0;
            }
            if (newDir === 'DOWN' && !goingUp) {
                dx = 0; dy = 1;
            }
        }

        // Keyboard Listener (Laptop)
        document.addEventListener('keydown', (event) => {
            // Cegah scrolling dengan panah saat main
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(event.code) > -1) {
                event.preventDefault();
            }

            if (event.key === 'ArrowLeft') changeDirection('LEFT');
            if (event.key === 'ArrowUp') changeDirection('UP');
            if (event.key === 'ArrowRight') changeDirection('RIGHT');
            if (event.key === 'ArrowDown') changeDirection('DOWN');
        });

    </script>
</body>
</html>
